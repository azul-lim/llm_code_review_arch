# 프롬프트 전략

## 1. 개요

이 문서는 LLM Code Review 시스템의 프롬프트 설계 원칙과 전략을 정의합니다.

---

## 2. 프롬프트 설계 원칙

### 2.1 핵심 원칙

| 원칙 | 설명 | 적용 방법 |
|------|------|-----------|
| **단일 역할** | 하나의 프롬프트는 하나의 역할만 수행 | 컴포넌트별 분리된 프롬프트 |
| **명시적 구조** | 출력 형식을 명확히 지정 | JSON Schema 제공 |
| **단계적 추론** | COT를 명시적으로 유도 | 분석 단계 열거 |
| **컨텍스트 최적화** | 필요한 정보만 전달 | 역할별 입력 필터링 |
| **Few-shot 활용** | 예시로 품질 향상 | 각 역할에 맞는 예시 포함 |

### 2.2 QWEN3 최적화

QWEN3 모델 특성에 맞춘 조정:

| 특성 | 대응 전략 |
|------|-----------|
| 긴 컨텍스트 지원 | 전체 함수 코드 포함 가능 |
| JSON 출력 지원 | 구조화된 출력 활용 |
| 다국어 지원 | 한국어 프롬프트 사용 가능 |
| 추론 능력 | 명시적 COT로 추론 유도 |

---

## 3. 프롬프트 구조

### 3.1 표준 프롬프트 템플릿

```
┌─────────────────────────────────────────────────────────────────┐
│                      시스템 프롬프트                             │
├─────────────────────────────────────────────────────────────────┤
│ 1. 역할 정의                                                    │
│    - 당신은 [역할]입니다.                                       │
│    - [역할의 목적과 책임]                                       │
│                                                                 │
│ 2. 분석 원칙/규칙                                               │
│    - 규칙 1: ...                                                │
│    - 규칙 2: ...                                                │
│                                                                 │
│ 3. 출력 규칙                                                    │
│    - JSON 형식으로만 응답                                       │
│    - 스키마 준수                                                │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      사용자 프롬프트                             │
├─────────────────────────────────────────────────────────────────┤
│ 1. 작업 설명                                                    │
│    - 다음 [데이터]를 [작업] 하세요.                             │
│                                                                 │
│ 2. 입력 데이터                                                  │
│    ## 섹션 1                                                    │
│    {data_1}                                                     │
│    ## 섹션 2                                                    │
│    {data_2}                                                     │
│                                                                 │
│ 3. 분석 지시 (COT 유도)                                         │
│    다음 단계를 수행하세요:                                      │
│    1. ...                                                       │
│    2. ...                                                       │
│                                                                 │
│ 4. 출력 형식                                                    │
│    {json_schema}                                                │
│                                                                 │
│ 5. (선택) Few-shot 예시                                         │
│    ## 예시                                                      │
│    입력: ...                                                    │
│    출력: ...                                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 섹션별 가이드라인

#### 역할 정의

```markdown
# 좋은 예
당신은 Storage Firmware 전문 코드 리뷰어입니다.
변경된 코드를 분석하여 버그와 문제점을 찾고 개선안을 제시합니다.

# 나쁜 예
코드를 리뷰하세요.
```

#### 분석 규칙

```markdown
# 좋은 예 - 구체적이고 검증 가능
규칙:
1. 포인터 사용 전 null 체크가 있는지 확인합니다.
2. malloc/free의 짝이 맞는지 확인합니다.
3. 에러 반환값이 확인되는지 검토합니다.

# 나쁜 예 - 모호함
규칙:
1. 코드를 꼼꼼히 봅니다.
2. 문제가 있으면 알려줍니다.
```

#### COT 유도

```markdown
# 좋은 예 - 명시적 단계
다음 단계를 순서대로 수행하고, 각 단계의 결과를 기록하세요:

Step 1: 변경된 코드 식별
- 어떤 라인이 변경되었나요?
- 변경 유형은 무엇인가요? (추가/수정/삭제)

Step 2: 동작 시뮬레이션
- buffer가 NULL일 때 어떻게 동작하나요?
- 정상 값일 때는 어떻게 동작하나요?

Step 3: 문제점 탐색
- Step 2의 시뮬레이션에서 문제가 발생하는 경로가 있나요?

# 나쁜 예 - 암묵적 기대
코드를 분석하고 시뮬레이션해서 버그를 찾으세요.
```

---

## 4. 컴포넌트별 프롬프트 전략

### 4.1 Description Refiner

**목표**: 자유 형식 → 구조화

```
전략:
- 추출 중심 (생성 최소화)
- 원문의 정보 보존
- 불확실한 경우 빈 값 허용

톤:
- 분석적, 객관적
- 추론 표시 명확 (예: "추정됨", "명시적으로 언급됨")
```

### 4.2 Change Matcher

**목표**: 명세 ↔ 변경 연결

```
전략:
- 증거 기반 매칭
- 신뢰도 명시
- 부분 매칭 허용

톤:
- 신중함, 근거 제시
- 불확실성 수치화
```

### 4.3 Code Reviewer

**목표**: 버그/문제 탐지 및 해결안 제시

```
전략:
- COT 필수
- 시뮬레이션 기반
- 실행 가능한 제안

톤:
- 전문적, 구체적
- 비판적이되 건설적
```

### 4.4 Summary Generator

**목표**: 전체 종합 및 행동 제안

```
전략:
- 우선순위화
- 명확한 권고
- 균형잡힌 평가

톤:
- 요약적, 결정 지향
- 명확한 다음 단계 제시
```

---

## 5. JSON 출력 전략

### 5.1 스키마 제공 방법

```markdown
## 출력 형식

다음 JSON 스키마에 맞춰 응답하세요. 다른 텍스트 없이 JSON만 출력합니다.

```json
{
  "$schema": "...",
  "type": "object",
  "properties": {
    "field1": {
      "type": "string",
      "description": "필드 설명"
    }
  },
  "required": ["field1"]
}
```

### 5.2 출력 검증

LLM 응답 후 검증 단계:

```python
def validate_llm_response(response: str, schema: dict) -> Tuple[bool, Any]:
    try:
        # JSON 파싱
        data = json.loads(response)

        # 스키마 검증
        jsonschema.validate(data, schema)

        return True, data
    except json.JSONDecodeError as e:
        return False, f"JSON 파싱 실패: {e}"
    except jsonschema.ValidationError as e:
        return False, f"스키마 검증 실패: {e.message}"
```

---

## 6. COT (Chain-of-Thought) 전략

### 6.1 COT 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                         COT 구조                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  reasoning_trace: {                                             │
│    steps: [                                                     │
│      {                                                          │
│        step_number: 1,                                          │
│        action: "수행한 분석 행동",                               │
│        observation: "관찰된 사실",                               │
│        inference: "추론 결과"                                   │
│      },                                                         │
│      ...                                                        │
│    ],                                                           │
│    conclusion: "최종 결론"                                      │
│  }                                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 COT 유도 프롬프트

```markdown
## 분석 수행

다음 단계를 명시적으로 수행하고, 각 단계의 사고 과정을 `reasoning_trace`에 기록하세요.

### Step 1: 변경점 식별
- Action: 변경된 코드 라인을 식별합니다.
- Observation: 무엇이 변경되었는지 기술합니다.
- Inference: 변경의 의도를 추론합니다.

### Step 2: 정상 경로 시뮬레이션
- Action: 정상 입력으로 코드를 실행해봅니다.
- Observation: 실행 결과를 기술합니다.
- Inference: 정상 동작 여부를 판단합니다.

### Step 3: 엣지 케이스 시뮬레이션
- Action: NULL, 0, 최대값 등으로 코드를 실행해봅니다.
- Observation: 각 케이스의 결과를 기술합니다.
- Inference: 문제 가능성을 판단합니다.

### Step 4: 결론 도출
- 위 분석을 종합하여 `conclusion`을 작성합니다.
```

---

## 7. Few-shot 전략

### 7.1 예시 선정 기준

| 기준 | 설명 |
|------|------|
| 대표성 | 일반적인 케이스를 대표 |
| 다양성 | 여러 유형의 케이스 포함 |
| 명확성 | 입출력 관계가 명확 |
| 적절한 길이 | 토큰 효율적 사용 |

### 7.2 예시 개수

| 컴포넌트 | 권장 예시 수 | 이유 |
|----------|-------------|------|
| Description Refiner | 1-2개 | 상대적으로 단순한 변환 |
| Change Matcher | 2개 | 매칭/미매칭 케이스 |
| Code Reviewer | 2-3개 | 다양한 버그 패턴 |
| Summary Generator | 1개 | 출력 형식 이해 |

### 7.3 예시 형식

```markdown
## 예시

### 입력
```
{input_example}
```

### 기대 출력
```json
{output_example}
```

### 설명
이 예시에서 [핵심 포인트]에 주목하세요.
```

---

## 8. 토큰 최적화

### 8.1 프롬프트 크기 예산

| 구성 요소 | 예상 토큰 | 비율 |
|-----------|-----------|------|
| 시스템 프롬프트 | 500-800 | 10-15% |
| 작업 지시 | 200-400 | 5-10% |
| 입력 데이터 | 2000-4000 | 50-60% |
| 스키마 | 300-500 | 5-10% |
| Few-shot | 500-1000 | 10-20% |
| 예비 | - | 5-10% |

### 8.2 컨텍스트 초과 시 전략

```python
def optimize_prompt(prompt: str, max_tokens: int) -> str:
    current_tokens = count_tokens(prompt)

    if current_tokens <= max_tokens:
        return prompt

    # 1. Few-shot 예시 제거
    prompt = remove_examples(prompt)
    if count_tokens(prompt) <= max_tokens:
        return prompt

    # 2. 상세 설명 축소
    prompt = reduce_descriptions(prompt)
    if count_tokens(prompt) <= max_tokens:
        return prompt

    # 3. 입력 데이터 잘라내기
    prompt = truncate_input_data(prompt, max_tokens)
    return prompt
```

---

## 9. 프롬프트 버전 관리

### 9.1 버전 형식

```
{component}_{version}_{language}.md

예시:
- refiner_v1.0_ko.md
- reviewer_v2.1_ko.md
```

### 9.2 변경 이력 관리

```markdown
# Prompt Changelog

## reviewer_v2.1 (2024-01-15)
- COT 단계 세분화
- 시뮬레이션 시나리오 추가

## reviewer_v2.0 (2024-01-10)
- JSON 출력 형식 변경
- 이슈 타입 추가
```

---

## 10. 관련 문서

- 프롬프트 템플릿: [templates/](templates/)
- 예시: [examples/prompt-examples/](../../examples/prompt-examples/)
- 컴포넌트 설계: [components/](../components/)
