# 개선 시스템 개요

## 1. 개선 목표

### 1.1 핵심 목표

| 목표 | 설명 | 측정 지표 |
|------|------|-----------|
| 리뷰 품질 향상 | 버그 탐지율 및 제안 정확도 향상 | 유효 리뷰 아이템 비율 |
| 응답 일관성 | 동일 입력에 대해 일관된 분석 결과 | 결과 재현율 |
| 유지보수성 | 개별 컴포넌트 수정 용이 | 컴포넌트 독립성 |
| 확장성 | 새로운 분석 유형 추가 용이 | 인터페이스 호환성 |

### 1.2 비목표 (Non-Goals)

- 리뷰 시스템과의 I/O 인터페이스 변경
- LLM 모델 자체의 변경 (QWEN3 유지)
- 실시간 처리 성능 최적화 (배치 처리 기준)

---

## 2. 개선 전략

### 2.1 아키텍처 전략: 파이프라인 기반 분리

**개념**: 단일 LLM 호출을 역할별 컴포넌트로 분리하되, 파이프라인으로 연결

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ Stage 1 │───→│ Stage 2 │───→│ Stage 3 │───→│ Stage 4 │
│ 정제    │    │ 매칭    │    │ 리뷰    │    │ 요약    │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

**장점**:
- 각 단계 독립적 테스트/개선 가능
- 실패 시 해당 단계만 재시도
- 단계별 캐싱 가능

### 2.2 호출 최적화 전략

| 전략 | 설명 | 적용 대상 |
|------|------|-----------|
| 병렬 처리 | 독립적인 파일들의 동시 처리 | 파일 간 분석 |
| 조건부 스킵 | 불필요한 단계 건너뛰기 | 단순 변경점 |
| 결과 캐싱 | 동일 입력에 대한 재사용 | PR Description 정제 |
| 배치 결합 | 작은 작업들의 묶음 처리 | 짧은 파일들 |

### 2.3 프롬프트 전략

| 전략 | 현재 | 개선 |
|------|------|------|
| 역할 정의 | 다중 역할 혼합 | 단일 역할 명확화 |
| 출력 형식 | 텍스트 + JSON 혼합 | JSON 전용 구조화 |
| COT 유도 | 암묵적 | 명시적 단계 정의 |
| Few-shot | 미사용 또는 제한적 | 역할별 예시 제공 |

---

## 3. 컴포넌트 구성

### 3.1 핵심 컴포넌트

```
┌─────────────────────────────────────────────────────────────────┐
│                     LLM Code Review Pipeline                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐                                          │
│  │ Description      │  PR Description → 구조화된 변경 명세      │
│  │ Refiner          │                                          │
│  └────────┬─────────┘                                          │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐                                          │
│  │ Change           │  명세 + File Diff → 매칭 결과            │
│  │ Matcher          │                                          │
│  └────────┬─────────┘                                          │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐                                          │
│  │ Code             │  매칭 결과 + 코드 → 리뷰 아이템          │
│  │ Reviewer         │                                          │
│  └────────┬─────────┘                                          │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐                                          │
│  │ Summary          │  전체 리뷰 → PR 요약                      │
│  │ Generator        │                                          │
│  └──────────────────┘                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 컴포넌트 역할 정의

| 컴포넌트 | 입력 | 출력 | 역할 |
|----------|------|------|------|
| Description Refiner | PR Description (raw) | 구조화된 변경 명세 | 자유 형식 설명을 분석 가능한 구조로 변환 |
| Change Matcher | 변경 명세 + File Diff | 매칭 결과 JSON | 명세와 실제 변경의 일치 여부 분석 |
| Code Reviewer | 매칭 결과 + 코드 컨텍스트 | 리뷰 아이템 목록 | 버그/문제 탐지 및 개선안 제시 |
| Summary Generator | 파일별 리뷰 결과 | PR 요약 | 전체 PR에 대한 종합 요약 |

### 3.3 컴포넌트 상세 문서

- [01-description-refiner.md](components/01-description-refiner.md)
- [02-change-matcher.md](components/02-change-matcher.md)
- [03-code-reviewer.md](components/03-code-reviewer.md)
- [04-summary-generator.md](components/04-summary-generator.md)

---

## 4. 데이터 흐름

### 4.1 전체 흐름

```
                    ┌─────────────────┐
                    │   입력 데이터    │
                    │ (리뷰 시스템)    │
                    └────────┬────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│    PR Description ──→ [Description Refiner] ──→ 변경 명세      │
│                              │                                 │
│                              ▼                                 │
│    ┌─────────────── 파일별 병렬 처리 ───────────────┐          │
│    │                                                │          │
│    │  File 1 ──→ [Change Matcher] ──→ 매칭 결과 1   │          │
│    │         ──→ [Code Reviewer]  ──→ 리뷰 1        │          │
│    │                                                │          │
│    │  File 2 ──→ [Change Matcher] ──→ 매칭 결과 2   │          │
│    │         ──→ [Code Reviewer]  ──→ 리뷰 2        │          │
│    │                                                │          │
│    │  File N ──→ [Change Matcher] ──→ 매칭 결과 N   │          │
│    │         ──→ [Code Reviewer]  ──→ 리뷰 N        │          │
│    │                                                │          │
│    └────────────────────────────────────────────────┘          │
│                              │                                 │
│                              ▼                                 │
│    전체 리뷰 결과 ──→ [Summary Generator] ──→ PR 요약          │
│                                                                │
└────────────────────────────────────────────────────────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   출력 데이터    │
                    │ (리뷰 시스템)    │
                    └─────────────────┘
```

### 4.2 데이터 의존성

| 단계 | 의존하는 데이터 | 병렬화 가능 |
|------|-----------------|-------------|
| Description Refiner | PR Description | N/A (1회) |
| Change Matcher | 정제된 명세 + 파일별 Diff | 파일 간 병렬 가능 |
| Code Reviewer | 매칭 결과 + 함수 코드 | 파일 간 병렬 가능 |
| Summary Generator | 모든 파일의 리뷰 결과 | N/A (1회) |

---

## 5. 기대 효과

| 영역 | 현재 | 개선 후 |
|------|------|---------|
| 리뷰 품질 | 작업 간 간섭으로 불안정 | 역할 분리로 집중된 분석 |
| 디버깅 | 문제 단계 추적 어려움 | 단계별 결과 확인 가능 |
| 확장성 | 프롬프트 전체 수정 필요 | 컴포넌트 단위 수정 |
| 테스트 | 종단간 테스트만 가능 | 단위 테스트 가능 |

---

## 6. 트레이드오프

| 개선 | 비용 |
|------|------|
| 역할 분리 | LLM 호출 횟수 증가 (비용/시간) |
| 구조화된 출력 | 프롬프트 복잡도 약간 증가 |
| 명시적 COT | 토큰 사용량 증가 |

**완화 전략**:
- 병렬 처리로 시간 비용 상쇄
- 조건부 스킵으로 불필요한 호출 방지
- 캐싱으로 중복 호출 제거

---

## 7. 다음 단계

→ [02-architecture.md](02-architecture.md): 상세 아키텍처 설계
