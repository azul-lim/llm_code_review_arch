# Task 및 Workflow 설계 명세서

> 이 문서는 LLM 기반 코드 리뷰 시스템의 Task 분화 및 Workflow를 정의합니다.
> AI(Claude Code, Copilot 등)가 구현할 때 참조하는 핵심 설계 문서입니다.

---

## 1. 설계 배경

### 1.1 기존 시스템 문제점

```
기존: 파일당 2회 호출 (리뷰 1회 + 검증 1회)
     └─ 리뷰 1회에서 6개 이상 Task 동시 수행
        ├─ 변경 의도 해석
        ├─ 표면 오류 탐지
        ├─ 로직 버그 탐지
        ├─ 도메인 규칙 검증
        ├─ 크로스파일 영향 분석
        └─ 개선 제안 생성

문제:
- 단일 호출에 과다한 역할 → 품질 불안정
- 복잡한 프롬프트 → 응답 누락/혼동
- 병렬 처리 불가 → 시간 비효율
```

### 1.2 개선 목표

```
목표: Task별 분화 → 병렬 처리 → 품질 + 속도 동시 개선

개선:
- 각 Task는 단일 목적
- 듀얼 모델로 병렬 처리
- Task 특성에 맞는 모델 할당
- 10분 내 PR 처리 완료
```

---

## 2. 환경 제약조건

### 2.1 모델 스펙

| 모델 | 컨텍스트 | 동시성 | 특성 |
|------|----------|--------|------|
| **QWEN3** | 256K tokens | 8개 동시 | 주 모델, 복잡한 추론에 적합 |
| **GPT-OSS** | 128K+ tokens | 50개/분 | 보조 모델, 빠른 처리에 적합 |

### 2.2 운영 제약

- **PR당 최대 처리 시간**: 10분
- **일반 PR 규모**: 20~30개 파일
- **대규모 PR 규모**: 50개 이상 파일
- **네트워크**: 폐쇄망 (외부 API 불가)

---

## 3. Input Level 정의

Task에 제공되는 입력 컨텍스트 수준을 정의합니다.

| Level | 명칭 | 포함 내용 | 토큰 규모 |
|-------|------|----------|----------|
| **L1** | Diff Only | 변경된 라인(diff)만 | 최소 |
| **L2** | Diff + Function | L1 + 변경점이 속한 함수 전체 코드 | 중간 |
| **L2+D** | L2 + Domain | L2 + 도메인 규칙/가이드라인 | 중간+ |
| **L3** | L2 + Surrounding | L2 + 호출하는/호출되는 함수 코드 | 큼 |
| **L4** | Full Context | 관련 파일 전체 (크로스파일) | 최대 |

```
Input Level 선택 기준:
- 단순 검사 → L1
- 함수 내 로직 분석 → L2
- 도메인 규칙 적용 → L2+D
- 함수 간 영향 분석 → L3
- 파일 간 영향 분석 → L4
```

---

## 4. Task 정의

### 4.1 Task 전체 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                         PR Level Tasks                          │
├─────────────────────────────────────────────────────────────────┤
│  P1: PR Description Refinement                                  │
│      [1회/PR] [QWEN3] [Input: Raw PR Description]               │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     File Level Tasks (병렬)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  F1: Intent Matching + Interpretation                     │  │
│  │      [L2] [GPT-OSS/QWEN3]                                 │  │
│  │      PR Description ↔ 파일 변경점 매칭 및 해석            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  F2: Surface Error Detection                              │  │
│  │      [L1] [GPT-OSS]                                       │  │
│  │      문법, 타입, 초기화 등 표면적 오류                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  F3: Logic Bug Detection ★ 핵심 ★                         │  │
│  │      [L2 + 추론가능한 L3] [QWEN3] [COT 필수]              │  │
│  │      로직 버그, 메모리, 동시성 문제                       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  F4: Domain Rule Validation                               │  │
│  │      [L2+D] [GPT-OSS/QWEN3]                               │  │
│  │      MISRA, 코딩표준, HW인터페이스 규칙                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  F5: Review Synthesis                                     │  │
│  │      [F1-F4 결과] [GPT-OSS/QWEN3]                         │  │
│  │      F1-F4 결과 통합, 중복 제거, 포맷팅                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  F6: Cross-file Analysis (Optional)                       │  │
│  │      [L4] [GPT-OSS] [컨텍스트 여유시에만]                 │  │
│  │      파일 간 영향, 인터페이스 일관성                      │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Validation Tasks (병렬)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
│  │     V1      │ │     V2      │ │     V3      │ │    V4     │ │
│  │ Description │ │  Location   │ │ Suggestion  │ │Halluci-   │ │
│  │  Accuracy   │ │Verification │ │  Validity   │ │nation Det.│ │
│  │ [GPT-OSS]   │ │ [GPT-OSS]   │ │ [GPT-OSS]   │ │ [GPT-OSS] │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │
│                                                                 │
│  ※ AND 로직: 모든 검증 통과 시에만 최종 출력에 포함            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         PR Level Tasks                          │
├─────────────────────────────────────────────────────────────────┤
│  P2: PR Summary Generation                                      │
│      [1회/PR] [QWEN3] [Input: 모든 파일 리뷰 결과]              │
└─────────────────────────────────────────────────────────────────┘
```

---

### 4.2 Task 상세 정의

#### P1: PR Description Refinement

| 항목 | 내용 |
|------|------|
| **목적** | Raw PR Description을 구조화된 형태로 정제 |
| **실행 시점** | PR당 1회, 최초 실행 |
| **Input Level** | N/A (PR Description 원문) |
| **모델** | QWEN3 |
| **Input** | PR Title, PR Description (원문) |
| **Output** | 구조화된 변경 의도 목록 (JSON) |

```
Output 구조:
{
  "refined_description": {
    "summary": "전체 변경 요약",
    "changes": [
      {
        "id": "C1",
        "type": "feature|bugfix|refactor|...",
        "description": "변경 내용 설명",
        "affected_areas": ["영향 영역"]
      }
    ]
  }
}
```

---

#### F1: Intent Matching + Interpretation

| 항목 | 내용 |
|------|------|
| **목적** | PR Description의 변경 의도와 파일 변경점 매칭 및 해석 |
| **실행 시점** | 파일당 1회, F2-F4와 병렬 |
| **Input Level** | L2 (Diff + Function) |
| **모델** | GPT-OSS (기본), QWEN3 (폴백) |
| **Input** | P1 결과 + 파일 diff + 함수 코드 |
| **Output** | 매칭 결과 + 변경점 해석 (JSON) |

```
Output 구조:
{
  "file": "path/to/file.c",
  "matches": [
    {
      "change_id": "C1",
      "relevance": "high|medium|low",
      "matched_hunks": [1, 2]
    }
  ],
  "interpretation": {
    "summary": "이 파일에서의 변경 요약",
    "details": [
      {
        "hunk_id": 1,
        "what": "무엇이 변경되었나",
        "why": "왜 변경되었나 (추론)"
      }
    ]
  }
}
```

---

#### F2: Surface Error Detection

| 항목 | 내용 |
|------|------|
| **목적** | 명백한 표면적 오류 탐지 |
| **실행 시점** | 파일당 1회, F1/F3/F4와 병렬 |
| **Input Level** | L1 (Diff Only) |
| **모델** | GPT-OSS |
| **Input** | 파일 diff |
| **Output** | 표면 오류 목록 (JSON) |

```
탐지 대상:
- 문법 오류 (명백한 것만)
- 타입 불일치
- 미초기화 변수 사용
- 명백한 범위 초과
- 누락된 return문
- 잘못된 연산자

Output 구조:
{
  "file": "path/to/file.c",
  "surface_issues": [
    {
      "id": "S1",
      "type": "uninitialized_var|type_mismatch|...",
      "severity": "error|warning",
      "location": {
        "start_line": 42,
        "end_line": 42
      },
      "description": "문제 설명",
      "suggestion": "수정 제안",
      "suggested_code": "수정된 코드"
    }
  ]
}
```

---

#### F3: Logic Bug Detection ★ 핵심 Task ★

| 항목 | 내용 |
|------|------|
| **목적** | 로직 버그, 메모리 문제, 동시성 문제 탐지 |
| **실행 시점** | 파일당 1회, F1/F2/F4와 병렬 |
| **Input Level** | L2 + 추론 가능한 L3 |
| **모델** | QWEN3 (필수) |
| **추론 방식** | Chain-of-Thought (COT) 필수 |
| **Input** | 파일 diff + 함수 코드 + (가능시) 호출 관계 |
| **Output** | 로직 버그 목록 + 추론 과정 (JSON) |

```
탐지 대상:
- 로직 오류 (조건문, 루프, 상태 전이)
- 메모리 안전성 (할당/해제, null 체크, 버퍼)
- 동시성 문제 (race condition, deadlock 가능성)
- 예외 경로 누락
- 에러 처리 불완전

Output 구조:
{
  "file": "path/to/file.c",
  "logic_issues": [
    {
      "id": "L1",
      "type": "memory_leak|race_condition|logic_error|...",
      "severity": "critical|major|minor",
      "location": {
        "start_line": 100,
        "end_line": 105
      },
      "description": "문제 설명",
      "reasoning": {
        "observation": "관찰된 현상",
        "analysis": "분석 과정",
        "conclusion": "결론"
      },
      "suggestion": "수정 제안",
      "suggested_code": "수정된 코드"
    }
  ]
}
```

**FW 특화 프롬프트 포함 내용:**
```
메모리 안전성:
- malloc/free 쌍 검증
- 버퍼 경계 검사
- null 포인터 역참조

동시성/인터럽트:
- ISR 컨텍스트 인식
- 인터럽트 비활성화 구간
- 공유 자원 보호
- lock 순서 일관성

상태 머신:
- 상태 전이 유효성
- 에러 상태 복구 경로
```

---

#### F4: Domain Rule Validation

| 항목 | 내용 |
|------|------|
| **목적** | 도메인 특화 규칙 및 코딩 표준 검증 |
| **실행 시점** | 파일당 1회, F1/F2/F3과 병렬 |
| **Input Level** | L2+D (Diff + Function + Domain Rules) |
| **모델** | GPT-OSS (기본), QWEN3 (폴백) |
| **Input** | 파일 diff + 함수 코드 + 도메인 규칙 문서 |
| **Output** | 규칙 위반 목록 (JSON) |

```
검증 대상:
- MISRA C/C++ 규칙 (적용 가능한 부분)
- 프로젝트 코딩 표준
- HW 인터페이스 패턴
- 에러 처리 정책
- 네이밍 컨벤션

Output 구조:
{
  "file": "path/to/file.c",
  "rule_violations": [
    {
      "id": "R1",
      "rule_id": "MISRA-C-2012-11.3",
      "rule_category": "misra|coding_standard|hw_interface|...",
      "severity": "required|advisory",
      "location": {
        "start_line": 55,
        "end_line": 55
      },
      "description": "규칙 위반 설명",
      "rule_text": "규칙 원문",
      "suggestion": "수정 제안",
      "suggested_code": "수정된 코드"
    }
  ]
}
```

**FW 특화 프롬프트 포함 내용:**
```
MISRA 규칙:
- [적용 대상 규칙 목록]

HW 인터페이스:
- 레지스터 접근 순서
- volatile 사용 요구사항
- 타이밍 제약

프로젝트 표준:
- 에러 코드 반환 규칙
- 리소스 정리 패턴
- 방어적 프로그래밍
```

---

#### F5: Review Synthesis

| 항목 | 내용 |
|------|------|
| **목적** | F1-F4 결과 통합, 중복 제거, 포맷팅 |
| **실행 시점** | F1-F4 완료 후 |
| **Input Level** | N/A (F1-F4 결과) |
| **모델** | GPT-OSS (기본), QWEN3 (폴백) |
| **Input** | F1, F2, F3, F4 결과 JSON |
| **Output** | 통합된 파일 리뷰 결과 (JSON) |

```
수행 작업:
- 중복 이슈 제거 (동일 위치, 유사 내용)
- 이슈 우선순위 정렬
- 일관된 포맷으로 통합
- 파일 전체 요약 생성

Output 구조:
{
  "file": "path/to/file.c",
  "summary": "파일 리뷰 요약",
  "issues": [
    {
      "id": "FILE-1",
      "source": "F2|F3|F4",
      "original_id": "S1|L1|R1",
      "type": "...",
      "severity": "...",
      "location": {...},
      "description": "...",
      "suggestion": "...",
      "suggested_code": "..."
    }
  ],
  "interpretation": {
    // F1 결과 포함
  }
}
```

---

#### F6: Cross-file Analysis (Optional)

| 항목 | 내용 |
|------|------|
| **목적** | 파일 간 영향 분석, 인터페이스 일관성 검증 |
| **실행 시점** | 컨텍스트 여유 시에만 실행 |
| **Input Level** | L4 (Full Context) |
| **모델** | GPT-OSS |
| **Input** | 관련 파일들의 변경점 + 인터페이스 정보 |
| **Output** | 크로스파일 이슈 목록 (JSON) |

```
실행 조건:
- 남은 컨텍스트 > 50K tokens
- 관련 파일이 2개 이상 변경됨
- 인터페이스 변경이 감지됨

탐지 대상:
- 인터페이스 불일치 (함수 시그니처 변경)
- 의존성 깨짐
- 전역 상태 영향

Output 구조:
{
  "cross_file_issues": [
    {
      "id": "X1",
      "type": "interface_mismatch|dependency_break|...",
      "severity": "...",
      "affected_files": ["file1.c", "file2.c"],
      "description": "...",
      "suggestion": "..."
    }
  ]
}
```

---

#### V1: Description Accuracy Validation

| 항목 | 내용 |
|------|------|
| **목적** | 리뷰 이슈 설명의 정확성 검증 |
| **실행 시점** | F5 완료 후, V2-V4와 병렬 |
| **모델** | GPT-OSS |
| **Input** | 이슈 + 원본 코드 |
| **Output** | Pass/Fail + 사유 |

```
검증 항목:
- 설명이 실제 코드와 일치하는가
- 기술 용어가 정확한가
- FW 용어(레지스터 이름, 인터럽트 등)가 맞는가

Output 구조:
{
  "issue_id": "FILE-1",
  "validation": "pass|fail",
  "reason": "검증 실패 시 사유"
}
```

---

#### V2: Location Verification

| 항목 | 내용 |
|------|------|
| **목적** | 이슈가 지적한 위치의 정확성 검증 |
| **실행 시점** | F5 완료 후, V1/V3/V4와 병렬 |
| **모델** | GPT-OSS |
| **Input** | 이슈 위치 + 원본 코드 |
| **Output** | Pass/Fail + 수정된 위치 |

```
검증 항목:
- 라인 번호가 실제 문제 위치와 일치하는가
- 지적된 코드가 해당 위치에 존재하는가

Output 구조:
{
  "issue_id": "FILE-1",
  "validation": "pass|fail",
  "corrected_location": {  // fail 시에만
    "start_line": 45,
    "end_line": 47
  },
  "reason": "검증 실패 시 사유"
}
```

---

#### V3: Suggestion Validity

| 항목 | 내용 |
|------|------|
| **목적** | 제안된 수정의 유효성 검증 |
| **실행 시점** | F5 완료 후, V1/V2/V4와 병렬 |
| **모델** | GPT-OSS |
| **Input** | 이슈 + 제안 코드 + 원본 컨텍스트 |
| **Output** | Pass/Fail + 사유 |

```
검증 항목:
- 제안 코드가 문법적으로 유효한가
- 제안이 실제로 문제를 해결하는가
- 제안이 새로운 문제를 야기하지 않는가
- FW 맥락에서 적용 가능한가 (ISR 호출 가능 등)

Output 구조:
{
  "issue_id": "FILE-1",
  "validation": "pass|fail",
  "reason": "검증 실패 시 사유"
}
```

---

#### V4: Hallucination Detection

| 항목 | 내용 |
|------|------|
| **목적** | 할루시네이션(존재하지 않는 정보) 탐지 |
| **실행 시점** | F5 완료 후, V1/V2/V3와 병렬 |
| **모델** | GPT-OSS |
| **Input** | 이슈 + 원본 코드 + 프로젝트 컨텍스트 |
| **Output** | Pass/Fail + 사유 |

```
검증 항목:
- 언급된 변수/함수가 실제 존재하는가
- 언급된 동작이 실제 코드와 일치하는가
- 언급된 API/규칙이 실제 존재하는가

Output 구조:
{
  "issue_id": "FILE-1",
  "validation": "pass|fail",
  "hallucination_type": "non_existent_var|wrong_behavior|...",
  "reason": "검증 실패 시 사유"
}
```

---

#### P2: PR Summary Generation

| 항목 | 내용 |
|------|------|
| **목적** | PR 전체 리뷰 결과 요약 생성 |
| **실행 시점** | 모든 파일 리뷰/검증 완료 후, PR당 1회 |
| **모델** | QWEN3 |
| **Input** | 모든 파일의 검증 완료된 리뷰 결과 |
| **Output** | PR 전체 요약 (JSON) |

```
Output 구조:
{
  "pr_summary": {
    "overall_assessment": "approve|request_changes|comment",
    "summary": "전체 리뷰 요약",
    "statistics": {
      "files_reviewed": 25,
      "issues_found": 12,
      "critical": 2,
      "major": 5,
      "minor": 5
    },
    "key_issues": [
      {
        "file": "...",
        "issue_id": "...",
        "summary": "..."
      }
    ],
    "recommendations": [
      "전체적인 권장사항"
    ]
  }
}
```

---

## 5. Workflow 정의

### 5.1 전체 파이프라인

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           PR Processing Pipeline                         │
└─────────────────────────────────────────────────────────────────────────┘

Time ──────────────────────────────────────────────────────────────────────→

[P1: Description Refiner]
        │
        ▼
┌───────────────────────────────────────────────────────────────┐
│                    파일 처리 (스트리밍)                        │
│                                                               │
│  File 1: ┌─────┬─────┬─────┬─────┐     ┌─────┐     ┌────────┐│
│          │ F1  │ F2  │ F3  │ F4  │────▶│ F5  │────▶│V1-V4   ││
│          └─────┴─────┴─────┴─────┘     └─────┘     │(병렬)  ││
│                  (병렬)                             └────────┘│
│                                                               │
│  File 2: ┌─────┬─────┬─────┬─────┐     ┌─────┐     ┌────────┐│
│          │ F1  │ F2  │ F3  │ F4  │────▶│ F5  │────▶│V1-V4   ││
│          └─────┴─────┴─────┴─────┘     └─────┘     │(병렬)  ││
│                  (병렬)                             └────────┘│
│                                                               │
│  ...계속...                                                    │
│                                                               │
│  ※ 파일 처리는 순차적이지 않음                                │
│  ※ 모델 가용성에 따라 동적 스케줄링                           │
└───────────────────────────────────────────────────────────────┘
        │
        ▼ (선택적)
[F6: Cross-file Analysis]
        │
        ▼
[P2: PR Summary Generation]
```

### 5.2 파일 내 Task 의존성

```
          ┌───────────────────────────────────────┐
          │           병렬 실행 가능              │
          │                                       │
          │   ┌────┐  ┌────┐  ┌────┐  ┌────┐     │
P1 결과 ──┼──▶│ F1 │  │ F2 │  │ F3 │  │ F4 │     │
          │   └──┬─┘  └──┬─┘  └──┬─┘  └──┬─┘     │
          │      │       │       │       │       │
          └──────┼───────┼───────┼───────┼───────┘
                 │       │       │       │
                 └───────┴───┬───┴───────┘
                             │
                             ▼
                          ┌────┐
                          │ F5 │ (F1-F4 결과 필요)
                          └──┬─┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          │   ┌────┐  ┌────┐ │ ┌────┐  ┌────┐  │
          │   │ V1 │  │ V2 │ │ │ V3 │  │ V4 │  │
          │   └──┬─┘  └──┬─┘ │ └──┬─┘  └──┬─┘  │
          │      │       │   │    │       │    │
          │      │       │   │    │       │    │
          └──────┼───────┼───┼────┼───────┼────┘
                 │       │   │    │       │
                 └───────┴───┴────┴───────┘
                             │
                             ▼
                     AND 로직 적용
                     (모두 Pass → 최종 출력)
```

### 5.3 Validation AND 로직

```python
# Validation 결과 처리 의사코드
def filter_issues(issues: List[Issue], validations: Dict) -> List[Issue]:
    """
    모든 Validation을 통과한 이슈만 최종 출력에 포함
    """
    final_issues = []

    for issue in issues:
        v1 = validations[issue.id].get('V1', {})
        v2 = validations[issue.id].get('V2', {})
        v3 = validations[issue.id].get('V3', {})
        v4 = validations[issue.id].get('V4', {})

        # AND 로직: 모든 검증 통과 필요
        if all([
            v1.get('validation') == 'pass',
            v2.get('validation') == 'pass',
            v3.get('validation') == 'pass',
            v4.get('validation') == 'pass'
        ]):
            # V2에서 위치 수정된 경우 반영
            if v2.get('corrected_location'):
                issue.location = v2['corrected_location']

            final_issues.append(issue)

    return final_issues
```

---

## 6. 모델 할당 전략

### 6.1 기본 할당

| Task | 기본 모델 | 폴백 모델 | 이유 |
|------|----------|----------|------|
| **P1** | QWEN3 | - | 복잡한 이해/구조화 필요 |
| **F1** | GPT-OSS | QWEN3 | 매칭은 상대적으로 단순 |
| **F2** | GPT-OSS | - | 표면 검사는 단순 |
| **F3** | QWEN3 | - | 복잡한 추론 필수 (COT) |
| **F4** | GPT-OSS | QWEN3 | 규칙 기반, 도메인 지식 참조 |
| **F5** | GPT-OSS | QWEN3 | 통합/포맷팅은 단순 |
| **F6** | GPT-OSS | - | 넓은 컨텍스트 필요 |
| **V1-V4** | GPT-OSS | - | 단순 검증 작업 |
| **P2** | QWEN3 | - | 전체 요약은 복잡 |

### 6.2 동적 로드 밸런싱

```
┌─────────────────────────────────────────────────────────────┐
│                   Dynamic Model Router                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Rate Limit 모니터링                                     │
│     ├─ QWEN3: 현재 활성 요청 수 / 8                        │
│     └─ GPT-OSS: 최근 1분 요청 수 / 50                      │
│                                                             │
│  2. 라우팅 결정                                             │
│     ├─ F3, P1, P2: 항상 QWEN3 (품질 우선)                  │
│     ├─ 기본 GPT-OSS Task:                                  │
│     │   ├─ GPT-OSS 여유 → GPT-OSS 사용                    │
│     │   └─ GPT-OSS 제한 도달 → QWEN3 폴백                 │
│     └─ QWEN3 가득 참 → 대기 큐에 추가                      │
│                                                             │
│  3. 우선순위                                                │
│     ├─ Critical: P1, F3, P2 (QWEN3 슬롯 우선 할당)         │
│     ├─ High: F5, V1-V4 (완료 대기 중인 파일 우선)          │
│     └─ Normal: F1, F2, F4, F6                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 시간 예산 (30 파일 기준)

```
목표: 10분 (600초) 이내 완료

┌─────────────────────────────────────────────────────────────┐
│  P1 (1회)           │████│                    ~30초        │
├─────────────────────────────────────────────────────────────┤
│  파일 처리 (30개)                                           │
│                                                             │
│  QWEN3 (F3): 30파일 ÷ 8동시 × ~20초 = ~75초               │
│  GPT-OSS (F1,F2,F4,F5,V1-V4): 병렬 처리 = ~200초          │
│                                                             │
│  ※ 파이프라인 효과로 실제는 더 빠름                        │
│  ※ 예상 총 파일 처리: ~300초                               │
├─────────────────────────────────────────────────────────────┤
│  F6 (선택)          │██│                      ~30초        │
├─────────────────────────────────────────────────────────────┤
│  P2 (1회)           │████│                    ~30초        │
├─────────────────────────────────────────────────────────────┤
│  Buffer                                         ~210초      │
├─────────────────────────────────────────────────────────────┤
│  Total                                          ~600초      │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. FW 특화 고려사항

### 7.1 Task별 FW 프롬프트 분배

```
┌─────────────────────────────────────────────────────────────┐
│  F2 (Surface Error)                                         │
│  └─ FW 특화 최소화 (범용 표면 검사)                        │
├─────────────────────────────────────────────────────────────┤
│  F3 (Logic Bug) ★ FW 핵심 ★                                 │
│  ├─ 메모리 안전성                                          │
│  │   - malloc/free 쌍 검증                                 │
│  │   - 버퍼 경계 검사                                      │
│  │   - null 포인터 역참조                                  │
│  ├─ 동시성/인터럽트                                        │
│  │   - ISR 컨텍스트 인식                                   │
│  │   - 인터럽트 disable/enable 쌍                          │
│  │   - 공유 자원 보호 (lock)                               │
│  └─ 상태 머신                                              │
│      - 상태 전이 유효성                                    │
│      - 에러 복구 경로                                      │
├─────────────────────────────────────────────────────────────┤
│  F4 (Domain Rule) ★ FW 핵심 ★                               │
│  ├─ MISRA C/C++ 규칙                                       │
│  ├─ HW 인터페이스 패턴                                     │
│  │   - 레지스터 접근 순서                                  │
│  │   - volatile 사용                                       │
│  └─ 프로젝트 코딩 표준                                     │
│      - 에러 코드 반환                                      │
│      - 리소스 정리 패턴                                    │
├─────────────────────────────────────────────────────────────┤
│  V1 (Description Accuracy)                                  │
│  └─ FW 용어 정확성 (레지스터 이름, 인터럽트 등)            │
├─────────────────────────────────────────────────────────────┤
│  V3 (Suggestion Validity)                                   │
│  └─ FW 맥락 적합성 (ISR 호출 가능 여부 등)                 │
├─────────────────────────────────────────────────────────────┤
│  V4 (Hallucination Detection)                               │
│  └─ FW 팩트 체크 (API 존재 여부, 스펙 일치 등)             │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 향후 확장 계획

```
현재 제약:
- 호출 관계(Call Graph) 추출 기능 없음 → L3 Input 제한적
- 정적 분석 도구 연동 없음 → 결정론적 검사 부재

향후 확장:
1. Call Graph 추출기 구현 → F3, F6 강화
2. 정적 분석 도구 연동 (CppCheck 등) → Hybrid Detection
3. Confidence Score 도입 → 우선순위 정렬 개선
```

---

## 8. 구현 가이드

### 8.1 구현 우선순위

```
Phase 1: 핵심 Task 구현
├─ P1: Description Refiner
├─ F3: Logic Bug Detection (COT 포함)
├─ F5: Review Synthesis
├─ V1-V4: Validation Tasks
└─ P2: PR Summary

Phase 2: 보조 Task 구현
├─ F1: Intent Matching
├─ F2: Surface Error Detection
└─ F4: Domain Rule Validation

Phase 3: 고급 기능
├─ F6: Cross-file Analysis
├─ Dynamic Model Router
└─ Pipeline Orchestrator
```

### 8.2 구현 시 주의사항

```
1. JSON Schema 준수
   - 모든 Task의 Input/Output은 정의된 스키마 따를 것
   - 스키마 검증 로직 필수

2. 에러 처리
   - LLM 응답 파싱 실패 시 재시도 로직
   - Task 실패 시 해당 이슈 건너뛰기 (전체 실패 방지)

3. 로깅
   - 각 Task 시작/종료 시간 기록
   - 모델 사용량 추적

4. 테스트
   - 각 Task 단위 테스트
   - 전체 파이프라인 통합 테스트
   - 실제 PR 데이터로 검증
```

### 8.3 다음 단계

```
이 문서를 기반으로:

1. 기존 코드 분석
   - 현재 프롬프트 구조 확인
   - 현재 JSON 스키마 확인
   - FW 특화 프롬프트 내용 추출

2. 상세 스키마 정의
   - schemas/input/ - 각 Task 입력 스키마
   - schemas/output/ - 각 Task 출력 스키마

3. 프롬프트 템플릿 작성
   - docs/prompts/templates/ - 각 Task별 프롬프트

4. 예시 데이터 준비
   - examples/input/ - 테스트 입력
   - examples/output/ - 기대 출력
```

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 0.1 | 2025-01-12 | 초안 작성 - Task 및 Workflow 정의 |

---

*이 문서는 AI(Claude Code, Copilot)가 구현 시 참조하는 설계 명세서입니다.*
